version: "3.9"

services:
  # ─────────────────────────────────────────────
  # PostgreSQL Database (port 5437 externally)
  # ─────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: rr_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-react_rigid_db}
      POSTGRES_USER: ${POSTGRES_USER:-appuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme_db_password}
    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5437}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-appuser} -d ${POSTGRES_DB:-react_rigid_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # Redis (port 6383 externally)
  # ─────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: rr_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_EXTERNAL_PORT:-6383}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # Django Backend API (port 8042)
  # ─────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rr_backend
    restart: unless-stopped
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             python manage.py seed_contacts --no-input 2>/dev/null;
             daphne -b 0.0.0.0 -p 8000 config.asgi:application"
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-1}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      - DJANGO_CORS_ALLOWED_ORIGINS=${DJANGO_CORS_ALLOWED_ORIGINS:-http://localhost:3081,http://172.168.1.95:3081}
      - POSTGRES_DB=${POSTGRES_DB:-react_rigid_db}
      - POSTGRES_USER=${POSTGRES_USER:-appuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme_db_password}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-react-vs-rigid-qa-app}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT:-https://api.smith.langchain.com}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      - MCP_ENABLED=${MCP_ENABLED:-true}
      - A2A_ENABLED=${A2A_ENABLED:-true}
    ports:
      - "${BACKEND_PORT:-8042}:8000"
    volumes:
      - ./backend:/app
      - ./research_papers:/app/research_papers
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # Celery Worker (async agent tasks)
  # ─────────────────────────────────────────────
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rr_celery_worker
    restart: unless-stopped
    command: celery -A config worker -l info -c 4 -Q default,agents,documents
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-1}
      - POSTGRES_DB=${POSTGRES_DB:-react_rigid_db}
      - POSTGRES_USER=${POSTGRES_USER:-appuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme_db_password}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-react-vs-rigid-qa-app}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT:-https://api.smith.langchain.com}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      - MCP_ENABLED=${MCP_ENABLED:-true}
      - A2A_ENABLED=${A2A_ENABLED:-true}
    volumes:
      - ./backend:/app
      - ./research_papers:/app/research_papers
      - media_volume:/app/media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # Celery Beat (scheduled tasks)
  # ─────────────────────────────────────────────
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rr_celery_beat
    restart: unless-stopped
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      - POSTGRES_DB=${POSTGRES_DB:-react_rigid_db}
      - POSTGRES_USER=${POSTGRES_USER:-appuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme_db_password}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # Flower - Celery Monitoring (port 5557)
  # ─────────────────────────────────────────────
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rr_flower
    restart: unless-stopped
    command: celery -A config flower --port=5555 --broker=redis://redis:6379/1
    ports:
      - "${FLOWER_PORT:-5557}:5555"
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app_network

  # ─────────────────────────────────────────────
  # React Frontend via Nginx (port 3081)
  # ─────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=http://172.168.1.95:${BACKEND_PORT:-8042}
        - REACT_APP_WS_URL=ws://172.168.1.95:${BACKEND_PORT:-8042}
        - REACT_APP_SITE_URL=http://172.168.1.95:${FRONTEND_PORT:-3081}
    container_name: rr_frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3081}:80"
    depends_on:
      - backend
    networks:
      - app_network

volumes:
  postgres_data:
  redis_data:
  static_volume:
  media_volume:

networks:
  app_network:
    driver: bridge
